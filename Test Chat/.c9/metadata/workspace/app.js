{"filter":false,"title":"app.js","tooltip":"/app.js","undoManager":{"mark":60,"position":60,"stack":[[{"start":{"row":0,"column":0},"end":{"row":0,"column":1},"action":"insert","lines":["d"],"id":2}],[{"start":{"row":0,"column":0},"end":{"row":0,"column":1},"action":"remove","lines":["d"],"id":3}],[{"start":{"row":71,"column":0},"end":{"row":72,"column":0},"action":"insert","lines":["",""],"id":4}],[{"start":{"row":72,"column":0},"end":{"row":73,"column":0},"action":"insert","lines":["",""],"id":5}],[{"start":{"row":73,"column":0},"end":{"row":74,"column":0},"action":"insert","lines":["",""],"id":6}],[{"start":{"row":74,"column":0},"end":{"row":75,"column":0},"action":"insert","lines":["",""],"id":7}],[{"start":{"row":73,"column":0},"end":{"row":73,"column":1},"action":"insert","lines":["/"],"id":8}],[{"start":{"row":73,"column":1},"end":{"row":73,"column":2},"action":"insert","lines":["/"],"id":9}],[{"start":{"row":73,"column":2},"end":{"row":73,"column":3},"action":"insert","lines":[" "],"id":10}],[{"start":{"row":73,"column":3},"end":{"row":73,"column":4},"action":"insert","lines":["c"],"id":11}],[{"start":{"row":73,"column":4},"end":{"row":73,"column":5},"action":"insert","lines":["h"],"id":12}],[{"start":{"row":73,"column":5},"end":{"row":73,"column":6},"action":"insert","lines":["a"],"id":13}],[{"start":{"row":73,"column":6},"end":{"row":73,"column":7},"action":"insert","lines":["t"],"id":14}],[{"start":{"row":73,"column":7},"end":{"row":73,"column":8},"action":"insert","lines":[" "],"id":15}],[{"start":{"row":73,"column":8},"end":{"row":74,"column":0},"action":"insert","lines":["",""],"id":16}],[{"start":{"row":74,"column":0},"end":{"row":75,"column":0},"action":"insert","lines":["",""],"id":17}],[{"start":{"row":75,"column":0},"end":{"row":170,"column":0},"action":"insert","lines":["app.get('/chat', ensureAuthenticated, function(req, res){","  res.render('chat', { user: req.user, title: 'Chat' });","});","","app.get('/user/:uid', ensureAuthenticated, function(req, res){","  var user_id = req.params.uid;","  db.findUserById(user_id, function (err, user) {","    console.log(\"[DEBUG][/user/uid] %s -> {%j, %j}\", user_id, err, user);","    if(err) {","      res.send(500);","      return","    }","    if(user === null) {","      res.send(404);","    }","    else {","      res.render('user', { seeUser: user, title: user.username, user: req.user });","    }","  });","});","","","var usersonline = {};","","io.sockets.on('connection', function (socket) {","  var connected_user = {};","","  // send updates with online users","  var i = setInterval(function() {","    socket.emit('whoshere', { 'users': usersonline });","  }, 3000);","","  console.info(\"[DEBUG][io.sockets][connection]\");","","","  socket.on('iamhere', function (data) {","    // This is sent by users when they connect, so we can map them to a user.","    console.log(\"[DEBUG][io.sockets][iamhere] %s\", data);","","    db.findUserById(data, function (err, user) {","      console.log(\"[DEBUG][iamhere] %s -> {%j, %j}\", data, err, user);","      if (user !== null) {","        connected_user = user;","        usersonline[connected_user.id] = {","          id: connected_user.id,","          name: connected_user.username","        };","      }","    });","  });","","","  socket.on('message', function (data) {","    if (connected_user.username === undefined) {","      console.warn('[WARN][io.sockets][message] Got message before iamhere {%s}', util.inspect(data));","      socket.emit('new message', {message: '<em>You must log in before chatting. That\\'s the rule</em>'});","      return","    }","    var msg = {","      message: data.message,","      from: connected_user.username,","      timestamp: new Date().getTime()","    }","","    console.log(\"[DEBUG][io.sockets][message] New message '%j' from user %s(@%s)\", msg, connected_user.username, connected_user.id);","","    db.saveMessage(msg, function (err, saved) {","      if (err || !saved) {","        socket.emit('new message', {message: util.format(\"<em>There was an error saving your message (%s)</em>\", msg.message), from: msg.from, timestamp: msg.timestamp});","        return;","      }","      socket.emit('new message', msg);","","      // Send message to everyone.","      socket.broadcast.emit('new message', msg);","    });","  });","","  db.findMessages(10, function (err, messages) {","    if (!err && messages.length > 0) {","      socket.emit('history', messages);","    }","  });","","","  socket.on('disconnect', function() {","    if (connected_user.id !== undefined) {","      delete usersonline[connected_user.id];","      console.log(\"[DEBUG][io.sockets][disconnect] user: %s(@%s) disconnected\", connected_user.username, connected_user.id);","    }","    else {","      console.log(\"[WARN][io.sockets][disconnect] Received disconnect message from another univers\");","    }","  });","});",""],"id":18}],[{"start":{"row":170,"column":0},"end":{"row":171,"column":0},"action":"insert","lines":["",""],"id":19}],[{"start":{"row":171,"column":0},"end":{"row":172,"column":0},"action":"insert","lines":["",""],"id":20}],[{"start":{"row":172,"column":0},"end":{"row":172,"column":1},"action":"insert","lines":["/"],"id":21}],[{"start":{"row":172,"column":1},"end":{"row":172,"column":2},"action":"insert","lines":["/"],"id":22}],[{"start":{"row":172,"column":2},"end":{"row":172,"column":3},"action":"insert","lines":[" "],"id":23}],[{"start":{"row":172,"column":3},"end":{"row":172,"column":4},"action":"insert","lines":["f"],"id":24}],[{"start":{"row":172,"column":4},"end":{"row":172,"column":5},"action":"insert","lines":["i"],"id":25}],[{"start":{"row":172,"column":5},"end":{"row":172,"column":6},"action":"insert","lines":["n"],"id":26}],[{"start":{"row":172,"column":6},"end":{"row":172,"column":7},"action":"insert","lines":[" "],"id":27}],[{"start":{"row":172,"column":7},"end":{"row":172,"column":8},"action":"insert","lines":["c"],"id":28}],[{"start":{"row":172,"column":8},"end":{"row":172,"column":9},"action":"insert","lines":["h"],"id":29}],[{"start":{"row":172,"column":9},"end":{"row":172,"column":10},"action":"insert","lines":["a"],"id":30}],[{"start":{"row":172,"column":10},"end":{"row":172,"column":11},"action":"insert","lines":["t"],"id":31}],[{"start":{"row":81,"column":2},"end":{"row":81,"column":4},"action":"remove","lines":["db"],"id":32},{"start":{"row":81,"column":2},"end":{"row":81,"column":10},"action":"insert","lines":["mongoose"]}],[{"start":{"row":114,"column":4},"end":{"row":114,"column":6},"action":"remove","lines":["db"],"id":33},{"start":{"row":114,"column":4},"end":{"row":114,"column":12},"action":"insert","lines":["mongoose"]}],[{"start":{"row":141,"column":4},"end":{"row":141,"column":6},"action":"remove","lines":["db"],"id":34},{"start":{"row":141,"column":4},"end":{"row":141,"column":12},"action":"insert","lines":["mongoose"]}],[{"start":{"row":153,"column":2},"end":{"row":153,"column":4},"action":"remove","lines":["db"],"id":35},{"start":{"row":153,"column":2},"end":{"row":153,"column":10},"action":"insert","lines":["mongoose"]}],[{"start":{"row":9,"column":39},"end":{"row":10,"column":0},"action":"insert","lines":["",""],"id":36}],[{"start":{"row":10,"column":0},"end":{"row":10,"column":40},"action":"insert","lines":["io = require('socket.io').listen(server)"],"id":37}],[{"start":{"row":10,"column":40},"end":{"row":10,"column":41},"action":"insert","lines":[","],"id":38}],[{"start":{"row":10,"column":40},"end":{"row":10,"column":41},"action":"remove","lines":[","],"id":39}],[{"start":{"row":10,"column":40},"end":{"row":10,"column":41},"action":"insert","lines":[";"],"id":40}],[{"start":{"row":10,"column":0},"end":{"row":10,"column":1},"action":"insert","lines":["v"],"id":41}],[{"start":{"row":10,"column":1},"end":{"row":10,"column":2},"action":"insert","lines":["a"],"id":42}],[{"start":{"row":10,"column":2},"end":{"row":10,"column":3},"action":"insert","lines":["r"],"id":43}],[{"start":{"row":10,"column":3},"end":{"row":10,"column":4},"action":"insert","lines":[" "],"id":44}],[{"start":{"row":10,"column":37},"end":{"row":10,"column":43},"action":"remove","lines":["server"],"id":45},{"start":{"row":10,"column":37},"end":{"row":10,"column":38},"action":"insert","lines":["p"]}],[{"start":{"row":10,"column":38},"end":{"row":10,"column":39},"action":"insert","lines":["o"],"id":46}],[{"start":{"row":10,"column":39},"end":{"row":10,"column":40},"action":"insert","lines":["r"],"id":47}],[{"start":{"row":10,"column":40},"end":{"row":10,"column":41},"action":"insert","lines":["t"],"id":48}],[{"start":{"row":10,"column":43},"end":{"row":11,"column":0},"action":"insert","lines":["",""],"id":49}],[{"start":{"row":11,"column":0},"end":{"row":11,"column":1},"action":"insert","lines":["v"],"id":50}],[{"start":{"row":11,"column":1},"end":{"row":11,"column":2},"action":"insert","lines":["a"],"id":51}],[{"start":{"row":11,"column":2},"end":{"row":11,"column":3},"action":"insert","lines":["r"],"id":52}],[{"start":{"row":11,"column":3},"end":{"row":11,"column":4},"action":"insert","lines":[" "],"id":53}],[{"start":{"row":11,"column":4},"end":{"row":11,"column":5},"action":"insert","lines":["x"],"id":54}],[{"start":{"row":11,"column":4},"end":{"row":11,"column":5},"action":"remove","lines":["x"],"id":55}],[{"start":{"row":11,"column":4},"end":{"row":11,"column":26},"action":"insert","lines":["util = require('util')"],"id":56}],[{"start":{"row":11,"column":26},"end":{"row":11,"column":27},"action":"insert","lines":[","],"id":57}],[{"start":{"row":11,"column":26},"end":{"row":11,"column":27},"action":"remove","lines":[","],"id":58}],[{"start":{"row":11,"column":26},"end":{"row":11,"column":27},"action":"insert","lines":[";"],"id":59}],[{"start":{"row":175,"column":0},"end":{"row":176,"column":0},"action":"insert","lines":["",""],"id":60}],[{"start":{"row":176,"column":0},"end":{"row":177,"column":0},"action":"insert","lines":["",""],"id":61}],[{"start":{"row":176,"column":0},"end":{"row":179,"column":1},"action":"insert","lines":["function ensureAuthenticated(req, res, next) {","  if (req.isAuthenticated()) { return next(); }","  res.redirect('/login')","}"],"id":62}],[{"start":{"row":79,"column":0},"end":{"row":83,"column":1},"action":"remove","lines":["","function ensureAuthenticated(req, res, next) {","  if (req.isAuthenticated()) { return next(); }","  res.redirect('/login')","}"],"id":64}],[{"start":{"row":76,"column":0},"end":{"row":172,"column":0},"action":"remove","lines":["","app.get('/chat', ensureAuthenticated, function(req, res){","  res.render('chat', { user: req.user, title: 'Chat' });","});","","app.get('/user/:uid', ensureAuthenticated, function(req, res){","  var user_id = req.params.uid;","  mongoose.findUserById(user_id, function (err, user) {","    console.log(\"[DEBUG][/user/uid] %s -> {%j, %j}\", user_id, err, user);","    if(err) {","      res.send(500);","      return","    }","    if(user === null) {","      res.send(404);","    }","    else {","      res.render('user', { seeUser: user, title: user.username, user: req.user });","    }","  });","});","","","var usersonline = {};","","io.sockets.on('connection', function (socket) {","  var connected_user = {};","","  // send updates with online users","  var i = setInterval(function() {","    socket.emit('whoshere', { 'users': usersonline });","  }, 3000);","","  console.info(\"[DEBUG][io.sockets][connection]\");","","","  socket.on('iamhere', function (data) {","    // This is sent by users when they connect, so we can map them to a user.","    console.log(\"[DEBUG][io.sockets][iamhere] %s\", data);","","    mongoose.findUserById(data, function (err, user) {","      console.log(\"[DEBUG][iamhere] %s -> {%j, %j}\", data, err, user);","      if (user !== null) {","        connected_user = user;","        usersonline[connected_user.id] = {","          id: connected_user.id,","          name: connected_user.username","        };","      }","    });","  });","","","  socket.on('message', function (data) {","    if (connected_user.username === undefined) {","      console.warn('[WARN][io.sockets][message] Got message before iamhere {%s}', util.inspect(data));","      socket.emit('new message', {message: '<em>You must log in before chatting. That\\'s the rule</em>'});","      return","    }","    var msg = {","      message: data.message,","      from: connected_user.username,","      timestamp: new Date().getTime()","    }","","    console.log(\"[DEBUG][io.sockets][message] New message '%j' from user %s(@%s)\", msg, connected_user.username, connected_user.id);","","    mongoose.saveMessage(msg, function (err, saved) {","      if (err || !saved) {","        socket.emit('new message', {message: util.format(\"<em>There was an error saving your message (%s)</em>\", msg.message), from: msg.from, timestamp: msg.timestamp});","        return;","      }","      socket.emit('new message', msg);","","      // Send message to everyone.","      socket.broadcast.emit('new message', msg);","    });","  });","","  mongoose.findMessages(10, function (err, messages) {","    if (!err && messages.length > 0) {","      socket.emit('history', messages);","    }","  });","","","  socket.on('disconnect', function() {","    if (connected_user.id !== undefined) {","      delete usersonline[connected_user.id];","      console.log(\"[DEBUG][io.sockets][disconnect] user: %s(@%s) disconnected\", connected_user.username, connected_user.id);","    }","    else {","      console.log(\"[WARN][io.sockets][disconnect] Received disconnect message from another univers\");","    }","  });","});",""],"id":63}]]},"ace":{"folds":[],"scrolltop":3.7800000000000002,"scrollleft":0,"selection":{"start":{"row":13,"column":0},"end":{"row":13,"column":0},"isBackwards":false},"options":{"guessTabSize":true,"useWrapMode":false,"wrapToView":true},"firstLineState":0},"timestamp":1491599385548,"hash":"ea15e4a87a0bfd21c762a0c1f56ea8635871c9a1"}